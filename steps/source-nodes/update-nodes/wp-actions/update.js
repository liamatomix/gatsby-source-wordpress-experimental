"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.default = exports.createSingleNode = exports.fetchAndCreateSingleNode = void 0;

require("source-map-support/register");

var _fetchGraphql = _interopRequireDefault(require("../../../../utils/fetch-graphql"));

var _store = _interopRequireDefault(require("../../../../store"));

var _formatLogMessage = require("../../../../utils/format-log-message");

var _chalk = _interopRequireDefault(require("chalk"));

var _helpers = require("../../helpers");

var _getGatsbyApi = require("../../../../utils/get-gatsby-api");

var _constants = require("../../../../constants");

var _atob = require("atob");

var _helpers2 = require("../../../create-schema-customization/helpers");

var _processNode = require("../../create-nodes/process-node");

// import { findConnectedNodeIds } from "~/steps/source-nodes/create-nodes/create-nodes"
const getDbIdFromRelayId = relayId => (0, _atob.atob)(relayId).split(`:`).reverse()[0];

const normalizeUri = ({
  uri,
  id,
  singleName
}) => {
  // if this is a draft url which could look like
  // /?p=543534 or /?page=4324
  // so we will create a proper path that Gatsby can handle
  // /post_graphql_name/post_db_id
  // this same logic is on the WP side in the preview template
  // to account for this situation.
  if (uri === null || uri === void 0 ? void 0 : uri.includes(`?`)) {
    const dbId = getDbIdFromRelayId(id);
    return `/${singleName}/${dbId}`;
  }

  return uri;
};

const fetchAndCreateSingleNode = async ({
  singleName,
  id,
  actionType,
  cachedNodeIds,
  isNewPostDraft,
  previewId = null,
  token = null
}) => {
  const {
    nodeQuery,
    previewQuery
  } = (0, _helpers.getQueryInfoBySingleFieldName)(singleName) || {};
  const query = previewId ? previewQuery : nodeQuery;
  const {
    helpers: {
      reporter,
      getNode
    }
  } = (0, _getGatsbyApi.getGatsbyApi)();

  if (!query) {
    reporter.log(``);
    reporter.warn((0, _formatLogMessage.formatLogMessage)(`A ${singleName} was updated, but no query was found for this node type.`));
    reporter.log(``);
    return {
      node: null
    };
  }

  const queryId = previewId !== null && previewId !== void 0 ? previewId : id;
  const headers = token ? {
    // don't change this header..
    // underscores and the word auth are being
    // stripped on the php side for some reason
    WPGatsbyPreview: token
  } : {};
  let {
    data
  } = await (0, _fetchGraphql.default)({
    headers,
    query,
    variables: {
      id: queryId
    }
  });
  let remoteNode = data[singleName]; // if we ask for a node that doesn't exist

  if (!data || data && remoteNode === null) {
    reporter.log(``);
    reporter.warn((0, _formatLogMessage.formatLogMessage)(`${queryId} ${singleName} was updated, but no data was returned for this node.`));
    reporter.log(``);
    return {
      node: null
    };
  }

  const existingNode = await getNode(id);

  if (previewId && existingNode) {
    const originalFieldsToRetain = {
      uri: existingNode.uri,
      link: existingNode.link,
      status: existingNode.status,
      slug: existingNode.slug,
      parent: existingNode.parent,
      databaseId: existingNode.databaseId,
      guid: existingNode.guid,
      id
    };
    remoteNode = Object.assign({}, remoteNode, originalFieldsToRetain);
  }

  remoteNode.uri = normalizeUri({
    uri: remoteNode.uri,
    singleName,
    id
  });
  data[singleName] = remoteNode; // returns an object

  const {
    additionalNodeIds,
    node
  } = await createSingleNode({
    singleName,
    id,
    actionType,
    data,
    cachedNodeIds
  });

  if (previewId && !isNewPostDraft) {
    reporter.log(``);
    reporter.info((0, _formatLogMessage.formatLogMessage)(`Preview for ${singleName} ${previewId} was updated at ${node.uri}.`));
    reporter.log(``);
  } else if (isNewPostDraft) {
    reporter.log(``);
    reporter.info((0, _formatLogMessage.formatLogMessage)(`Blank node for ${singleName} draft ${previewId} was created at ${node.uri}.`));
    reporter.log(``);
  }

  return {
    node,
    additionalNodeIds
  } || null;
};

exports.fetchAndCreateSingleNode = fetchAndCreateSingleNode;

const createSingleNode = async ({
  singleName,
  id,
  actionType,
  data,
  cachedNodeIds
}) => {
  const state = _store.default.getState();

  const {
    helpers,
    pluginOptions
  } = state.gatsbyApi;
  const {
    wpUrl
  } = state.remoteSchema;
  const {
    typeInfo
  } = (0, _helpers.getQueryInfoBySingleFieldName)(singleName);

  if (!cachedNodeIds) {
    cachedNodeIds = await helpers.cache.get(_constants.CREATED_NODE_IDS);
  }

  const updatedNodeContent = Object.assign({}, data[singleName], {
    nodeType: typeInfo.nodesTypeName,
    type: typeInfo.nodesTypeName
  });
  const processedNode = await (0, _processNode.processNode)({
    node: updatedNodeContent,
    pluginOptions,
    wpUrl,
    helpers,
    test: true
  });
  const {
    actions
  } = helpers;
  const {
    createContentDigest
  } = helpers;
  let remoteNode = Object.assign({}, processedNode, {
    id: id,
    parent: null,
    internal: {
      contentDigest: createContentDigest(updatedNodeContent),
      type: (0, _helpers2.buildTypeName)(typeInfo.nodesTypeName)
    }
  });
  /**
   * @todo This commented code will be used to refetch connected nodes that might need to be connected back to this node but aren't currently
   * see the note at the top find-connected-nodes.js for more info
   */
  // const connectedNodeIds = findConnectedNodeIds(updatedNodeContent) || []
  // .filter(
  //   async childNodeId => {
  //     const childNode = await getNode(childNodeId)
  //     return childNode
  //   }
  // )
  // if (connectedNodeIds && connectedNodeIds.length) {
  //   dump(childNodeIds)
  // } else {
  //   dump(remoteNode)
  //   helpers.reporter.info(`no children for ${singleName}`)
  // }

  const typeSettings = (0, _helpers2.getTypeSettingsByType)({
    name: typeInfo.nodesTypeName
  });
  let additionalNodeIds;
  let cancelUpdate;

  if (typeSettings.beforeChangeNode && typeof typeSettings.beforeChangeNode === `function`) {
    const {
      additionalNodeIds: receivedAdditionalNodeIds,
      remoteNode: receivedRemoteNode,
      cancelUpdate: receivedCancelUpdate
    } = (await typeSettings.beforeChangeNode({
      actionType: actionType,
      remoteNode,
      actions,
      helpers,
      fetchGraphql: _fetchGraphql.default,
      typeSettings,
      buildTypeName: _helpers2.buildTypeName,
      type: typeInfo.nodesTypeName,
      wpStore: _store.default
    })) || {};
    additionalNodeIds = receivedAdditionalNodeIds;
    cancelUpdate = receivedCancelUpdate;

    if (receivedRemoteNode) {
      remoteNode = receivedRemoteNode;
    }
  }

  if (cancelUpdate) {
    return {
      additionalNodeIds,
      remoteNode: null
    };
  }

  if (remoteNode) {
    await actions.createNode(remoteNode);
    cachedNodeIds.push(remoteNode.id);

    if (additionalNodeIds && additionalNodeIds.length) {
      additionalNodeIds.forEach(id => cachedNodeIds.push(id));
    }

    await helpers.cache.set(_constants.CREATED_NODE_IDS, cachedNodeIds);
  }

  return {
    additionalNodeIds,
    node: remoteNode
  };
};

exports.createSingleNode = createSingleNode;

const wpActionUPDATE = async ({
  helpers,
  wpAction // intervalRefetching,

}) => {
  const reportUpdate = ({
    setAction
  } = {}) => {
    const actionType = setAction || wpAction.actionType;
    reporter.log(``);
    reporter.info((0, _formatLogMessage.formatLogMessage)(`${_chalk.default.bold(`${actionType.toLowerCase()} ${wpAction.referencedNodeSingularName}`)} ${wpAction.title} (#${wpAction.referencedNodeID})`));
    reporter.log(``);
  };

  const {
    reporter,
    cache,
    actions
  } = helpers;
  let cachedNodeIds = await cache.get(_constants.CREATED_NODE_IDS);

  const state = _store.default.getState();

  const {
    gatsbyApi: {
      pluginOptions: {
        verbose
      },
      helpers: {
        getNode
      }
    }
  } = state;
  const nodeId = wpAction.referencedNodeGlobalRelayID;
  const existingNode = await getNode(nodeId);

  if (wpAction.referencedNodeStatus !== `publish`) {
    // if the post status isn't publish anymore, we need to remove the node
    // by removing it from cached nodes so it's garbage collected by Gatsby
    const validNodeIds = cachedNodeIds.filter(cachedId => cachedId !== nodeId);
    await cache.set(_constants.CREATED_NODE_IDS, validNodeIds);

    if (existingNode) {
      await actions.touchNode({
        nodeId
      });
      await actions.deleteNode({
        node: existingNode
      });
      reportUpdate({
        setAction: `DELETE`
      });
    }

    return;
  }

  const {
    node
  } = await fetchAndCreateSingleNode({
    id: nodeId,
    actionType: wpAction.actionType,
    singleName: wpAction.referencedNodeSingularName,
    cachedNodeIds
  });

  if (node) {
    reportUpdate();

    if (verbose) {
      const nodeEntries = existingNode ? Object.entries(existingNode) : null;

      if (nodeEntries === null || nodeEntries === void 0 ? void 0 : nodeEntries.length) {
        var _nodeEntries$filter;

        (_nodeEntries$filter = nodeEntries.filter(([key]) => !key.includes(`modifiedGmt`) && key !== `modified`)) === null || _nodeEntries$filter === void 0 ? void 0 : _nodeEntries$filter.forEach(([key, value]) => {
          if (!node || !node[key] || !value) {
            return;
          }

          if ( // if the value of this field changed, log it
          typeof node[key] === `string` && value !== node[key]) {
            reporter.log(``);
            reporter.info(_chalk.default.bold(`${key} changed`));

            if (value.length < 250 && node[key].length < 250) {
              reporter.log(``);
              reporter.log(`${_chalk.default.italic.bold(`    from`)}`);
              reporter.log(`      ${value}`);
              reporter.log(_chalk.default.italic.bold(`    to`));
              reporter.log(`      ${node[key]}`);
              reporter.log(``);
            }
          }
        });
        reporter.log(``);
      }
    }
  } // return cachedNodeIds

};

var _default = wpActionUPDATE;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zdGVwcy9zb3VyY2Utbm9kZXMvdXBkYXRlLW5vZGVzL3dwLWFjdGlvbnMvdXBkYXRlLmpzIl0sIm5hbWVzIjpbImdldERiSWRGcm9tUmVsYXlJZCIsInJlbGF5SWQiLCJzcGxpdCIsInJldmVyc2UiLCJub3JtYWxpemVVcmkiLCJ1cmkiLCJpZCIsInNpbmdsZU5hbWUiLCJpbmNsdWRlcyIsImRiSWQiLCJmZXRjaEFuZENyZWF0ZVNpbmdsZU5vZGUiLCJhY3Rpb25UeXBlIiwiY2FjaGVkTm9kZUlkcyIsImlzTmV3UG9zdERyYWZ0IiwicHJldmlld0lkIiwidG9rZW4iLCJub2RlUXVlcnkiLCJwcmV2aWV3UXVlcnkiLCJxdWVyeSIsImhlbHBlcnMiLCJyZXBvcnRlciIsImdldE5vZGUiLCJsb2ciLCJ3YXJuIiwibm9kZSIsInF1ZXJ5SWQiLCJoZWFkZXJzIiwiV1BHYXRzYnlQcmV2aWV3IiwiZGF0YSIsInZhcmlhYmxlcyIsInJlbW90ZU5vZGUiLCJleGlzdGluZ05vZGUiLCJvcmlnaW5hbEZpZWxkc1RvUmV0YWluIiwibGluayIsInN0YXR1cyIsInNsdWciLCJwYXJlbnQiLCJkYXRhYmFzZUlkIiwiZ3VpZCIsImFkZGl0aW9uYWxOb2RlSWRzIiwiY3JlYXRlU2luZ2xlTm9kZSIsImluZm8iLCJzdGF0ZSIsInN0b3JlIiwiZ2V0U3RhdGUiLCJwbHVnaW5PcHRpb25zIiwiZ2F0c2J5QXBpIiwid3BVcmwiLCJyZW1vdGVTY2hlbWEiLCJ0eXBlSW5mbyIsImNhY2hlIiwiZ2V0IiwiQ1JFQVRFRF9OT0RFX0lEUyIsInVwZGF0ZWROb2RlQ29udGVudCIsIm5vZGVUeXBlIiwibm9kZXNUeXBlTmFtZSIsInR5cGUiLCJwcm9jZXNzZWROb2RlIiwidGVzdCIsImFjdGlvbnMiLCJjcmVhdGVDb250ZW50RGlnZXN0IiwiaW50ZXJuYWwiLCJjb250ZW50RGlnZXN0IiwidHlwZVNldHRpbmdzIiwibmFtZSIsImNhbmNlbFVwZGF0ZSIsImJlZm9yZUNoYW5nZU5vZGUiLCJyZWNlaXZlZEFkZGl0aW9uYWxOb2RlSWRzIiwicmVjZWl2ZWRSZW1vdGVOb2RlIiwicmVjZWl2ZWRDYW5jZWxVcGRhdGUiLCJmZXRjaEdyYXBocWwiLCJidWlsZFR5cGVOYW1lIiwid3BTdG9yZSIsImNyZWF0ZU5vZGUiLCJwdXNoIiwibGVuZ3RoIiwiZm9yRWFjaCIsInNldCIsIndwQWN0aW9uVVBEQVRFIiwid3BBY3Rpb24iLCJyZXBvcnRVcGRhdGUiLCJzZXRBY3Rpb24iLCJjaGFsayIsImJvbGQiLCJ0b0xvd2VyQ2FzZSIsInJlZmVyZW5jZWROb2RlU2luZ3VsYXJOYW1lIiwidGl0bGUiLCJyZWZlcmVuY2VkTm9kZUlEIiwidmVyYm9zZSIsIm5vZGVJZCIsInJlZmVyZW5jZWROb2RlR2xvYmFsUmVsYXlJRCIsInJlZmVyZW5jZWROb2RlU3RhdHVzIiwidmFsaWROb2RlSWRzIiwiZmlsdGVyIiwiY2FjaGVkSWQiLCJ0b3VjaE5vZGUiLCJkZWxldGVOb2RlIiwibm9kZUVudHJpZXMiLCJPYmplY3QiLCJlbnRyaWVzIiwia2V5IiwidmFsdWUiLCJpdGFsaWMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUVBOztBQUlBOztBQVJBO0FBVUEsTUFBTUEsa0JBQWtCLEdBQUlDLE9BQUQsSUFBYSxnQkFBS0EsT0FBTCxFQUFjQyxLQUFkLENBQXFCLEdBQXJCLEVBQXlCQyxPQUF6QixHQUFtQyxDQUFuQyxDQUF4Qzs7QUFFQSxNQUFNQyxZQUFZLEdBQUcsQ0FBQztBQUFFQyxFQUFBQSxHQUFGO0FBQU9DLEVBQUFBLEVBQVA7QUFBV0MsRUFBQUE7QUFBWCxDQUFELEtBQTZCO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQUlGLEdBQUosYUFBSUEsR0FBSix1QkFBSUEsR0FBRyxDQUFFRyxRQUFMLENBQWUsR0FBZixDQUFKLEVBQXdCO0FBQ3RCLFVBQU1DLElBQUksR0FBR1Qs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QUEsUUFBUSxDQUFDRSxHQUFULENBQWMsRUFBZDtBQUNBRixZQUFBQSxRQUFRLENBQUNxQixJQUFULENBQWN5QyxlQUFNQyxJQUFOLENBQVksR0FBRWlCLEdBQUksVUFBbEIsQ0FBZDs7QUFFQSxnQkFBSUMsS0FBSyxDQUFDMUIsTUFBTixHQUFlLEdBQWYsSUFBc0JuRCxJQUFJLENBQUM0RSxHQUFELENBQUosQ0FBVXpCLE1BQVYsR0FBbUIsR0FBN0MsRUFBa0Q7QUFDaER2RCxjQUFBQSxRQUFRLENBQUNFLEdBQVQsQ0FBYyxFQUFkO0FBQ0FGLGNBQUFBLFFBQVEsQ0FBQ0UsR0FBVCxDQUFjLEdBQUU0RCxlQUFNb0IsTUFBTixDQUFhbkIsSUFBYixDQUFtQixVQUFuQixDQUE4QixFQUE5QztBQUNBL0QsY0FBQUEsUUFBUSxDQUFDRSxHQUFULENBQWMsU0FBUStFLEtBQU0sRUFBNUI7QUFDQWpGLGNBQUFBLFFBQVEsQ0FBQ0UsR0FBVCxDQUFhNEQsZUFBTW9CLE1BQU4sQ0FBYW5CLElBQWIsQ0FBbUIsUUFBbkIsQ0FBYjtBQUNBL0QsY0FBQUEsUUFBUSxDQUFDRSxHQUFULENBQWMsU0FBUUUsSUFBSSxDQUFDNEUsR0FBRCxDQUFNLEVBQWhDO0FBQ0FoRixjQUFBQSxRQUFRLENBQUNFLEdBQVQsQ0FBYyxFQUFkO0FBQ0Q7QUFDRjtBQUNGLFNBeEJIO0FBMEJBRixRQUFBQSxRQUFRLENBQUNFLEdBQVQsQ0FBYyxFQUFkO0FBQ0Q7QUFDRjtBQUNGLEdBMUZHLENBNEZKOztBQUNELENBakdEOztlQW1HZXdELGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2hHcmFwaHFsIGZyb20gXCJ+L3V0aWxzL2ZldGNoLWdyYXBocWxcIlxuaW1wb3J0IHN0b3JlIGZyb20gXCJ+L3N0b3JlXCJcbmltcG9ydCB7IGZvcm1hdExvZ01lc3NhZ2UgfSBmcm9tIFwifi91dGlscy9mb3JtYXQtbG9nLW1lc3NhZ2VcIlxuaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiXG5pbXBvcnQgeyBnZXRRdWVyeUluZm9CeVNpbmdsZUZpZWxkTmFtZSB9IGZyb20gXCIuLi8uLi9oZWxwZXJzXCJcbmltcG9ydCB7IGdldEdhdHNieUFwaSB9IGZyb20gXCJ+L3V0aWxzL2dldC1nYXRzYnktYXBpXCJcbmltcG9ydCB7IENSRUFURURfTk9ERV9JRFMgfSBmcm9tIFwifi9jb25zdGFudHNcIlxuLy8gaW1wb3J0IHsgZmluZENvbm5lY3RlZE5vZGVJZHMgfSBmcm9tIFwifi9zdGVwcy9zb3VyY2Utbm9kZXMvY3JlYXRlLW5vZGVzL2NyZWF0ZS1ub2Rlc1wiXG5cbmltcG9ydCB7IGF0b2IgfSBmcm9tIFwiYXRvYlwiXG5cbmltcG9ydCB7XG4gIGJ1aWxkVHlwZU5hbWUsXG4gIGdldFR5cGVTZXR0aW5nc0J5VHlwZSxcbn0gZnJvbSBcIn4vc3RlcHMvY3JlYXRlLXNjaGVtYS1jdXN0b21pemF0aW9uL2hlbHBlcnNcIlxuaW1wb3J0IHsgcHJvY2Vzc05vZGUgfSBmcm9tIFwifi9zdGVwcy9zb3VyY2Utbm9kZXMvY3JlYXRlLW5vZGVzL3Byb2Nlc3Mtbm9kZVwiXG5cbmNvbnN0IGdldERiSWRGcm9tUmVsYXlJZCA9IChyZWxheUlkKSA9PiBhdG9iKHJlbGF5SWQpLnNwbGl0KGA6YCkucmV2ZXJzZSgpWzBdXG5cbmNvbnN0IG5vcm1hbGl6ZVVyaSA9ICh7IHVyaSwgaWQsIHNpbmdsZU5hbWUgfSkgPT4ge1xuICAvLyBpZiB0aGlzIGlzIGEgZHJhZnQgdXJsIHdoaWNoIGNvdWxkIGxvb2sgbGlrZVxuICAvLyAvP3A9NTQzNTM0IG9yIC8/cGFnZT00MzI0XG4gIC8vIHNvIHdlIHdpbGwgY3JlYXRlIGEgcHJvcGVyIHBhdGggdGhhdCBHYXRzYnkgY2FuIGhhbmRsZVxuICAvLyAvcG9zdF9ncmFwaHFsX25hbWUvcG9zdF9kYl9pZFxuICAvLyB0aGlzIHNhbWUgbG9naWMgaXMgb24gdGhlIFdQIHNpZGUgaW4gdGhlIHByZXZpZXcgdGVtcGxhdGVcbiAgLy8gdG8gYWNjb3VudCBmb3IgdGhpcyBzaXR1YXRpb24uXG4gIGlmICh1cmk/LmluY2x1ZGVzKGA/YCkpIHtcbiAgICBjb25zdCBkYklkID0gZ2V0RGJJZEZyb21SZWxheUlkKGlkKVxuXG4gICAgcmV0dXJuIGAvJHtzaW5nbGVOYW1lfS8ke2RiSWR9YFxuICB9XG5cbiAgcmV0dXJuIHVyaVxufVxuXG5leHBvcnQgY29uc3QgZmV0Y2hBbmRDcmVhdGVTaW5nbGVOb2RlID0gYXN5bmMgKHtcbiAgc2luZ2xlTmFtZSxcbiAgaWQsXG4gIGFjdGlvblR5cGUsXG4gIGNhY2hlZE5vZGVJZHMsXG4gIGlzTmV3UG9zdERyYWZ0LFxuICBwcmV2aWV3SWQgPSBudWxsLFxuICB0b2tlbiA9IG51bGwsXG59KSA9PiB7XG4gIGNvbnN0IHsgbm9kZVF1ZXJ5LCBwcmV2aWV3UXVlcnkgfSA9XG4gICAgZ2V0UXVlcnlJbmZvQnlTaW5nbGVGaWVsZE5hbWUoc2luZ2xlTmFtZSkgfHwge31cblxuICBjb25zdCBxdWVyeSA9IHByZXZpZXdJZCA/IHByZXZpZXdRdWVyeSA6IG5vZGVRdWVyeVxuXG4gIGNvbnN0IHtcbiAgICBoZWxwZXJzOiB7IHJlcG9ydGVyLCBnZXROb2RlIH0sXG4gIH0gPSBnZXRHYXRzYnlBcGkoKVxuXG4gIGlmICghcXVlcnkpIHtcbiAgICByZXBvcnRlci5sb2coYGApXG4gICAgcmVwb3J0ZXIud2FybihcbiAgICAgIGZvcm1hdExvZ01lc3NhZ2UoXG4gICAgICAgIGBBICR7c2luZ2xlTmFtZX0gd2FzIHVwZGF0ZWQsIGJ1dCBubyBxdWVyeSB3YXMgZm91bmQgZm9yIHRoaXMgbm9kZSB0eXBlLmBcbiAgICAgIClcbiAgICApXG4gICAgcmVwb3J0ZXIubG9nKGBgKVxuXG4gICAgcmV0dXJuIHsgbm9kZTogbnVsbCB9XG4gIH1cblxuICBjb25zdCBxdWVyeUlkID0gcHJldmlld0lkID8/IGlkXG5cbiAgY29uc3QgaGVhZGVycyA9IHRva2VuXG4gICAgPyB7XG4gICAgICAgIC8vIGRvbid0IGNoYW5nZSB0aGlzIGhlYWRlci4uXG4gICAgICAgIC8vIHVuZGVyc2NvcmVzIGFuZCB0aGUgd29yZCBhdXRoIGFyZSBiZWluZ1xuICAgICAgICAvLyBzdHJpcHBlZCBvbiB0aGUgcGhwIHNpZGUgZm9yIHNvbWUgcmVhc29uXG4gICAgICAgIFdQR2F0c2J5UHJldmlldzogdG9rZW4sXG4gICAgICB9XG4gICAgOiB7fVxuXG4gIGxldCB7IGRhdGEgfSA9IGF3YWl0IGZldGNoR3JhcGhxbCh7XG4gICAgaGVhZGVycyxcbiAgICBxdWVyeSxcbiAgICB2YXJpYWJsZXM6IHtcbiAgICAgIGlkOiBxdWVyeUlkLFxuICAgIH0sXG4gIH0pXG5cbiAgbGV0IHJlbW90ZU5vZGUgPSBkYXRhW3NpbmdsZU5hbWVdXG5cbiAgLy8gaWYgd2UgYXNrIGZvciBhIG5vZGUgdGhhdCBkb2Vzbid0IGV4aXN0XG4gIGlmICghZGF0YSB8fCAoZGF0YSAmJiByZW1vdGVOb2RlID09PSBudWxsKSkge1xuICAgIHJlcG9ydGVyLmxvZyhgYClcbiAgICByZXBvcnRlci53YXJuKFxuICAgICAgZm9ybWF0TG9nTWVzc2FnZShcbiAgICAgICAgYCR7cXVlcnlJZH0gJHtzaW5nbGVOYW1lfSB3YXMgdXBkYXRlZCwgYnV0IG5vIGRhdGEgd2FzIHJldHVybmVkIGZvciB0aGlzIG5vZGUuYFxuICAgICAgKVxuICAgIClcbiAgICByZXBvcnRlci5sb2coYGApXG5cbiAgICByZXR1cm4geyBub2RlOiBudWxsIH1cbiAgfVxuXG4gIGNvbnN0IGV4aXN0aW5nTm9kZSA9IGF3YWl0IGdldE5vZGUoaWQpXG5cbiAgaWYgKHByZXZpZXdJZCAmJiBleGlzdGluZ05vZGUpIHtcbiAgICBjb25zdCBvcmlnaW5hbEZpZWxkc1RvUmV0YWluID0ge1xuICAgICAgdXJpOiBleGlzdGluZ05vZGUudXJpLFxuICAgICAgbGluazogZXhpc3RpbmdOb2RlLmxpbmssXG4gICAgICBzdGF0dXM6IGV4aXN0aW5nTm9kZS5zdGF0dXMsXG4gICAgICBzbHVnOiBleGlzdGluZ05vZGUuc2x1ZyxcbiAgICAgIHBhcmVudDogZXhpc3RpbmdOb2RlLnBhcmVudCxcbiAgICAgIGRhdGFiYXNlSWQ6IGV4aXN0aW5nTm9kZS5kYXRhYmFzZUlkLFxuICAgICAgZ3VpZDogZXhpc3RpbmdOb2RlLmd1aWQsXG4gICAgICBpZCxcbiAgICB9XG5cbiAgICByZW1vdGVOb2RlID0ge1xuICAgICAgLi4ucmVtb3RlTm9kZSxcbiAgICAgIC4uLm9yaWdpbmFsRmllbGRzVG9SZXRhaW4sXG4gICAgfVxuICB9XG5cbiAgcmVtb3RlTm9kZS51cmkgPSBub3JtYWxpemVVcmkoe1xuICAgIHVyaTogcmVtb3RlTm9kZS51cmksXG4gICAgc2luZ2xlTmFtZSxcbiAgICBpZCxcbiAgfSlcblxuICBkYXRhW3NpbmdsZU5hbWVdID0gcmVtb3RlTm9kZVxuXG4gIC8vIHJldHVybnMgYW4gb2JqZWN0XG4gIGNvbnN0IHsgYWRkaXRpb25hbE5vZGVJZHMsIG5vZGUgfSA9IGF3YWl0IGNyZWF0ZVNpbmdsZU5vZGUoe1xuICAgIHNpbmdsZU5hbWUsXG4gICAgaWQsXG4gICAgYWN0aW9uVHlwZSxcbiAgICBkYXRhLFxuICAgIGNhY2hlZE5vZGVJZHMsXG4gIH0pXG5cbiAgaWYgKHByZXZpZXdJZCAmJiAhaXNOZXdQb3N0RHJhZnQpIHtcbiAgICByZXBvcnRlci5sb2coYGApXG4gICAgcmVwb3J0ZXIuaW5mbyhcbiAgICAgIGZvcm1hdExvZ01lc3NhZ2UoXG4gICAgICAgIGBQcmV2aWV3IGZvciAke3NpbmdsZU5hbWV9ICR7cHJldmlld0lkfSB3YXMgdXBkYXRlZCBhdCAke25vZGUudXJpfS5gXG4gICAgICApXG4gICAgKVxuICAgIHJlcG9ydGVyLmxvZyhgYClcbiAgfSBlbHNlIGlmIChpc05ld1Bvc3REcmFmdCkge1xuICAgIHJlcG9ydGVyLmxvZyhgYClcbiAgICByZXBvcnRlci5pbmZvKFxuICAgICAgZm9ybWF0TG9nTWVzc2FnZShcbiAgICAgICAgYEJsYW5rIG5vZGUgZm9yICR7c2luZ2xlTmFtZX0gZHJhZnQgJHtwcmV2aWV3SWR9IHdhcyBjcmVhdGVkIGF0ICR7bm9kZS51cml9LmBcbiAgICAgIClcbiAgICApXG4gICAgcmVwb3J0ZXIubG9nKGBgKVxuICB9XG5cbiAgcmV0dXJuIHsgbm9kZSwgYWRkaXRpb25hbE5vZGVJZHMgfSB8fCBudWxsXG59XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVTaW5nbGVOb2RlID0gYXN5bmMgKHtcbiAgc2luZ2xlTmFtZSxcbiAgaWQsXG4gIGFjdGlvblR5cGUsXG4gIGRhdGEsXG4gIGNhY2hlZE5vZGVJZHMsXG59KSA9PiB7XG4gIGNvbnN0IHN0YXRlID0gc3RvcmUuZ2V0U3RhdGUoKVxuICBjb25zdCB7IGhlbHBlcnMsIHBsdWdpbk9wdGlvbnMgfSA9IHN0YXRlLmdhdHNieUFwaVxuICBjb25zdCB7IHdwVXJsIH0gPSBzdGF0ZS5yZW1vdGVTY2hlbWFcblxuICBjb25zdCB7IHR5cGVJbmZvIH0gPSBnZXRRdWVyeUluZm9CeVNpbmdsZUZpZWxkTmFtZShzaW5nbGVOYW1lKVxuXG4gIGlmICghY2FjaGVkTm9kZUlkcykge1xuICAgIGNhY2hlZE5vZGVJZHMgPSBhd2FpdCBoZWxwZXJzLmNhY2hlLmdldChDUkVBVEVEX05PREVfSURTKVxuICB9XG5cbiAgY29uc3QgdXBkYXRlZE5vZGVDb250ZW50ID0ge1xuICAgIC4uLmRhdGFbc2luZ2xlTmFtZV0sXG4gICAgbm9kZVR5cGU6IHR5cGVJbmZvLm5vZGVzVHlwZU5hbWUsXG4gICAgdHlwZTogdHlwZUluZm8ubm9kZXNUeXBlTmFtZSxcbiAgfVxuXG4gIGNvbnN0IHByb2Nlc3NlZE5vZGUgPSBhd2FpdCBwcm9jZXNzTm9kZSh7XG4gICAgbm9kZTogdXBkYXRlZE5vZGVDb250ZW50LFxuICAgIHBsdWdpbk9wdGlvbnMsXG4gICAgd3BVcmwsXG4gICAgaGVscGVycyxcbiAgICB0ZXN0OiB0cnVlLFxuICB9KVxuXG4gIGNvbnN0IHsgYWN0aW9ucyB9ID0gaGVscGVyc1xuXG4gIGNvbnN0IHsgY3JlYXRlQ29udGVudERpZ2VzdCB9ID0gaGVscGVyc1xuXG4gIGxldCByZW1vdGVOb2RlID0ge1xuICAgIC4uLnByb2Nlc3NlZE5vZGUsXG4gICAgaWQ6IGlkLFxuICAgIHBhcmVudDogbnVsbCxcbiAgICBpbnRlcm5hbDoge1xuICAgICAgY29udGVudERpZ2VzdDogY3JlYXRlQ29udGVudERpZ2VzdCh1cGRhdGVkTm9kZUNvbnRlbnQpLFxuICAgICAgdHlwZTogYnVpbGRUeXBlTmFtZSh0eXBlSW5mby5ub2Rlc1R5cGVOYW1lKSxcbiAgICB9LFxuICB9XG5cbiAgLyoqXG4gICAqIEB0b2RvIFRoaXMgY29tbWVudGVkIGNvZGUgd2lsbCBiZSB1c2VkIHRvIHJlZmV0Y2ggY29ubmVjdGVkIG5vZGVzIHRoYXQgbWlnaHQgbmVlZCB0byBiZSBjb25uZWN0ZWQgYmFjayB0byB0aGlzIG5vZGUgYnV0IGFyZW4ndCBjdXJyZW50bHlcbiAgICogc2VlIHRoZSBub3RlIGF0IHRoZSB0b3AgZmluZC1jb25uZWN0ZWQtbm9kZXMuanMgZm9yIG1vcmUgaW5mb1xuICAgKi9cbiAgLy8gY29uc3QgY29ubmVjdGVkTm9kZUlkcyA9IGZpbmRDb25uZWN0ZWROb2RlSWRzKHVwZGF0ZWROb2RlQ29udGVudCkgfHwgW11cbiAgLy8gLmZpbHRlcihcbiAgLy8gICBhc3luYyBjaGlsZE5vZGVJZCA9PiB7XG4gIC8vICAgICBjb25zdCBjaGlsZE5vZGUgPSBhd2FpdCBnZXROb2RlKGNoaWxkTm9kZUlkKVxuICAvLyAgICAgcmV0dXJuIGNoaWxkTm9kZVxuICAvLyAgIH1cbiAgLy8gKVxuXG4gIC8vIGlmIChjb25uZWN0ZWROb2RlSWRzICYmIGNvbm5lY3RlZE5vZGVJZHMubGVuZ3RoKSB7XG4gIC8vICAgZHVtcChjaGlsZE5vZGVJZHMpXG4gIC8vIH0gZWxzZSB7XG4gIC8vICAgZHVtcChyZW1vdGVOb2RlKVxuICAvLyAgIGhlbHBlcnMucmVwb3J0ZXIuaW5mbyhgbm8gY2hpbGRyZW4gZm9yICR7c2luZ2xlTmFtZX1gKVxuICAvLyB9XG5cbiAgY29uc3QgdHlwZVNldHRpbmdzID0gZ2V0VHlwZVNldHRpbmdzQnlUeXBlKHtcbiAgICBuYW1lOiB0eXBlSW5mby5ub2Rlc1R5cGVOYW1lLFxuICB9KVxuXG4gIGxldCBhZGRpdGlvbmFsTm9kZUlkc1xuICBsZXQgY2FuY2VsVXBkYXRlXG5cbiAgaWYgKFxuICAgIHR5cGVTZXR0aW5ncy5iZWZvcmVDaGFuZ2VOb2RlICYmXG4gICAgdHlwZW9mIHR5cGVTZXR0aW5ncy5iZWZvcmVDaGFuZ2VOb2RlID09PSBgZnVuY3Rpb25gXG4gICkge1xuICAgIGNvbnN0IHtcbiAgICAgIGFkZGl0aW9uYWxOb2RlSWRzOiByZWNlaXZlZEFkZGl0aW9uYWxOb2RlSWRzLFxuICAgICAgcmVtb3RlTm9kZTogcmVjZWl2ZWRSZW1vdGVOb2RlLFxuICAgICAgY2FuY2VsVXBkYXRlOiByZWNlaXZlZENhbmNlbFVwZGF0ZSxcbiAgICB9ID1cbiAgICAgIChhd2FpdCB0eXBlU2V0dGluZ3MuYmVmb3JlQ2hhbmdlTm9kZSh7XG4gICAgICAgIGFjdGlvblR5cGU6IGFjdGlvblR5cGUsXG4gICAgICAgIHJlbW90ZU5vZGUsXG4gICAgICAgIGFjdGlvbnMsXG4gICAgICAgIGhlbHBlcnMsXG4gICAgICAgIGZldGNoR3JhcGhxbCxcbiAgICAgICAgdHlwZVNldHRpbmdzLFxuICAgICAgICBidWlsZFR5cGVOYW1lLFxuICAgICAgICB0eXBlOiB0eXBlSW5mby5ub2Rlc1R5cGVOYW1lLFxuICAgICAgICB3cFN0b3JlOiBzdG9yZSxcbiAgICAgIH0pKSB8fCB7fVxuXG4gICAgYWRkaXRpb25hbE5vZGVJZHMgPSByZWNlaXZlZEFkZGl0aW9uYWxOb2RlSWRzXG4gICAgY2FuY2VsVXBkYXRlID0gcmVjZWl2ZWRDYW5jZWxVcGRhdGVcblxuICAgIGlmIChyZWNlaXZlZFJlbW90ZU5vZGUpIHtcbiAgICAgIHJlbW90ZU5vZGUgPSByZWNlaXZlZFJlbW90ZU5vZGVcbiAgICB9XG4gIH1cblxuICBpZiAoY2FuY2VsVXBkYXRlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFkZGl0aW9uYWxOb2RlSWRzLFxuICAgICAgcmVtb3RlTm9kZTogbnVsbCxcbiAgICB9XG4gIH1cblxuICBpZiAocmVtb3RlTm9kZSkge1xuICAgIGF3YWl0IGFjdGlvbnMuY3JlYXRlTm9kZShyZW1vdGVOb2RlKVxuXG4gICAgY2FjaGVkTm9kZUlkcy5wdXNoKHJlbW90ZU5vZGUuaWQpXG5cbiAgICBpZiAoYWRkaXRpb25hbE5vZGVJZHMgJiYgYWRkaXRpb25hbE5vZGVJZHMubGVuZ3RoKSB7XG4gICAgICBhZGRpdGlvbmFsTm9kZUlkcy5mb3JFYWNoKChpZCkgPT4gY2FjaGVkTm9kZUlkcy5wdXNoKGlkKSlcbiAgICB9XG5cbiAgICBhd2FpdCBoZWxwZXJzLmNhY2hlLnNldChDUkVBVEVEX05PREVfSURTLCBjYWNoZWROb2RlSWRzKVxuICB9XG5cbiAgcmV0dXJuIHsgYWRkaXRpb25hbE5vZGVJZHMsIG5vZGU6IHJlbW90ZU5vZGUgfVxufVxuXG5jb25zdCB3cEFjdGlvblVQREFURSA9IGFzeW5jICh7XG4gIGhlbHBlcnMsXG4gIHdwQWN0aW9uLFxuICAvLyBpbnRlcnZhbFJlZmV0Y2hpbmcsXG59KSA9PiB7XG4gIGNvbnN0IHJlcG9ydFVwZGF0ZSA9ICh7IHNldEFjdGlvbiB9ID0ge30pID0+IHtcbiAgICBjb25zdCBhY3Rpb25UeXBlID0gc2V0QWN0aW9uIHx8IHdwQWN0aW9uLmFjdGlvblR5cGVcblxuICAgIHJlcG9ydGVyLmxvZyhgYClcbiAgICByZXBvcnRlci5pbmZvKFxuICAgICAgZm9ybWF0TG9nTWVzc2FnZShcbiAgICAgICAgYCR7Y2hhbGsuYm9sZChcbiAgICAgICAgICBgJHthY3Rpb25UeXBlLnRvTG93ZXJDYXNlKCl9ICR7d3BBY3Rpb24ucmVmZXJlbmNlZE5vZGVTaW5ndWxhck5hbWV9YFxuICAgICAgICApfSAke3dwQWN0aW9uLnRpdGxlfSAoIyR7d3BBY3Rpb24ucmVmZXJlbmNlZE5vZGVJRH0pYFxuICAgICAgKVxuICAgIClcbiAgICByZXBvcnRlci5sb2coYGApXG4gIH1cblxuICBjb25zdCB7IHJlcG9ydGVyLCBjYWNoZSwgYWN0aW9ucyB9ID0gaGVscGVyc1xuXG4gIGxldCBjYWNoZWROb2RlSWRzID0gYXdhaXQgY2FjaGUuZ2V0KENSRUFURURfTk9ERV9JRFMpXG5cbiAgY29uc3Qgc3RhdGUgPSBzdG9yZS5nZXRTdGF0ZSgpXG4gIGNvbnN0IHtcbiAgICBnYXRzYnlBcGk6IHtcbiAgICAgIHBsdWdpbk9wdGlvbnM6IHsgdmVyYm9zZSB9LFxuICAgICAgaGVscGVyczogeyBnZXROb2RlIH0sXG4gICAgfSxcbiAgfSA9IHN0YXRlXG5cbiAgY29uc3Qgbm9kZUlkID0gd3BBY3Rpb24ucmVmZXJlbmNlZE5vZGVHbG9iYWxSZWxheUlEXG5cbiAgY29uc3QgZXhpc3RpbmdOb2RlID0gYXdhaXQgZ2V0Tm9kZShub2RlSWQpXG5cbiAgaWYgKHdwQWN0aW9uLnJlZmVyZW5jZWROb2RlU3RhdHVzICE9PSBgcHVibGlzaGApIHtcbiAgICAvLyBpZiB0aGUgcG9zdCBzdGF0dXMgaXNuJ3QgcHVibGlzaCBhbnltb3JlLCB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgbm9kZVxuICAgIC8vIGJ5IHJlbW92aW5nIGl0IGZyb20gY2FjaGVkIG5vZGVzIHNvIGl0J3MgZ2FyYmFnZSBjb2xsZWN0ZWQgYnkgR2F0c2J5XG4gICAgY29uc3QgdmFsaWROb2RlSWRzID0gY2FjaGVkTm9kZUlkcy5maWx0ZXIoKGNhY2hlZElkKSA9PiBjYWNoZWRJZCAhPT0gbm9kZUlkKVxuXG4gICAgYXdhaXQgY2FjaGUuc2V0KENSRUFURURfTk9ERV9JRFMsIHZhbGlkTm9kZUlkcylcblxuICAgIGlmIChleGlzdGluZ05vZGUpIHtcbiAgICAgIGF3YWl0IGFjdGlvbnMudG91Y2hOb2RlKHsgbm9kZUlkIH0pXG4gICAgICBhd2FpdCBhY3Rpb25zLmRlbGV0ZU5vZGUoeyBub2RlOiBleGlzdGluZ05vZGUgfSlcbiAgICAgIHJlcG9ydFVwZGF0ZSh7IHNldEFjdGlvbjogYERFTEVURWAgfSlcbiAgICB9XG5cbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvbnN0IHsgbm9kZSB9ID0gYXdhaXQgZmV0Y2hBbmRDcmVhdGVTaW5nbGVOb2RlKHtcbiAgICBpZDogbm9kZUlkLFxuICAgIGFjdGlvblR5cGU6IHdwQWN0aW9uLmFjdGlvblR5cGUsXG4gICAgc2luZ2xlTmFtZTogd3BBY3Rpb24ucmVmZXJlbmNlZE5vZGVTaW5ndWxhck5hbWUsXG4gICAgY2FjaGVkTm9kZUlkcyxcbiAgfSlcblxuICBpZiAobm9kZSkge1xuICAgIHJlcG9ydFVwZGF0ZSgpXG5cbiAgICBpZiAodmVyYm9zZSkge1xuICAgICAgY29uc3Qgbm9kZUVudHJpZXMgPSBleGlzdGluZ05vZGUgPyBPYmplY3QuZW50cmllcyhleGlzdGluZ05vZGUpIDogbnVsbFxuXG4gICAgICBpZiAobm9kZUVudHJpZXM/Lmxlbmd0aCkge1xuICAgICAgICBub2RlRW50cmllc1xuICAgICAgICAgIC5maWx0ZXIoKFtrZXldKSA9PiAha2V5LmluY2x1ZGVzKGBtb2RpZmllZEdtdGApICYmIGtleSAhPT0gYG1vZGlmaWVkYClcbiAgICAgICAgICA/LmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFub2RlIHx8ICFub2RlW2tleV0gfHwgIXZhbHVlKSB7XG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIC8vIGlmIHRoZSB2YWx1ZSBvZiB0aGlzIGZpZWxkIGNoYW5nZWQsIGxvZyBpdFxuICAgICAgICAgICAgICB0eXBlb2Ygbm9kZVtrZXldID09PSBgc3RyaW5nYCAmJlxuICAgICAgICAgICAgICB2YWx1ZSAhPT0gbm9kZVtrZXldXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmVwb3J0ZXIubG9nKGBgKVxuICAgICAgICAgICAgICByZXBvcnRlci5pbmZvKGNoYWxrLmJvbGQoYCR7a2V5fSBjaGFuZ2VkYCkpXG5cbiAgICAgICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA8IDI1MCAmJiBub2RlW2tleV0ubGVuZ3RoIDwgMjUwKSB7XG4gICAgICAgICAgICAgICAgcmVwb3J0ZXIubG9nKGBgKVxuICAgICAgICAgICAgICAgIHJlcG9ydGVyLmxvZyhgJHtjaGFsay5pdGFsaWMuYm9sZChgICAgIGZyb21gKX1gKVxuICAgICAgICAgICAgICAgIHJlcG9ydGVyLmxvZyhgICAgICAgJHt2YWx1ZX1gKVxuICAgICAgICAgICAgICAgIHJlcG9ydGVyLmxvZyhjaGFsay5pdGFsaWMuYm9sZChgICAgIHRvYCkpXG4gICAgICAgICAgICAgICAgcmVwb3J0ZXIubG9nKGAgICAgICAke25vZGVba2V5XX1gKVxuICAgICAgICAgICAgICAgIHJlcG9ydGVyLmxvZyhgYClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG5cbiAgICAgICAgcmVwb3J0ZXIubG9nKGBgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIHJldHVybiBjYWNoZWROb2RlSWRzXG59XG5cbmV4cG9ydCBkZWZhdWx0IHdwQWN0aW9uVVBEQVRFXG4iXX0=