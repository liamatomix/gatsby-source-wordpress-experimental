"use strict";

exports.__esModule = true;
exports.transformFields = exports.returnAliasedFieldName = exports.getAliasedFieldName = void 0;

require("source-map-support/register");

var _fieldTransformers = require("./field-transformers");

var _helpers = require("../helpers");

const handleCustomScalars = field => {
  const fieldTypeIsACustomScalar = field.type.kind === `SCALAR` && !(0, _helpers.typeIsASupportedScalar)(field.type);

  if (fieldTypeIsACustomScalar) {
    // if this field is an unsupported custom scalar,
    // type it as JSON
    field.type.name = `JSON`;
  }

  const fieldTypeOfTypeIsACustomScalar = field.type.ofType && field.type.ofType.kind === `SCALAR` && !(0, _helpers.typeIsASupportedScalar)(field.type);

  if (fieldTypeOfTypeIsACustomScalar) {
    // if this field is an unsupported custom scalar,
    // type it as JSON
    field.type.ofType.name = `JSON`;
  }

  return field;
}; // this is used to alias fields that conflict with Gatsby node fields
// for ex Gatsby and WPGQL both have a `parent` field


const getAliasedFieldName = ({
  fieldAliases,
  field
}) => fieldAliases && fieldAliases[field.name] ? fieldAliases[field.name] : field.name;

exports.getAliasedFieldName = getAliasedFieldName;

const returnAliasedFieldName = ({
  fieldAliases,
  field
}) => fieldAliases && fieldAliases[field.name] ? `${fieldAliases[field.name]}: ${field.name}` : field.name;

exports.returnAliasedFieldName = returnAliasedFieldName;

const excludeField = ({
  field,
  fieldName,
  thisTypeSettings,
  fieldBlacklist,
  parentTypeSettings,
  parentInterfacesImplementingTypeSettings
}) => // this field wasn't previously fetched, so we shouldn't
// add it to our schema
!(0, _helpers.fieldOfTypeWasFetched)(field.type) || // this field was excluded on it's parent fields Type
parentTypeSettings.excludeFieldNames && parentTypeSettings.excludeFieldNames.includes(fieldName) || // this field is on an interface type and one of the implementing types has this field excluded on it.
parentInterfacesImplementingTypeSettings && parentInterfacesImplementingTypeSettings.find(typeSetting => typeSetting.excludeFieldNames && typeSetting.excludeFieldNames.find(excludedFieldName => fieldName === excludedFieldName)) || // the type of this field was excluded via plugin options
thisTypeSettings.exclude || // node interface types are created elsewhere
thisTypeSettings.nodeInterface || // field is blacklisted
fieldBlacklist.includes(fieldName) || // this field has required input args
field.args && field.args.find(arg => arg.type.kind === `NON_NULL`) || // this field has no typeName
!(0, _helpers.findTypeName)(field.type) || // field is a non null object
// @todo this looks unnecessary. Need to look into why non null object types are excluded
field.type.kind === `NON_NULL` && field.type.ofType.kind === `OBJECT` || // field is a non null enum
field.type.kind === `NON_NULL` && field.type.ofType.kind === `ENUM`;
/**
 * Transforms fields from the WPGQL schema to work in the Gatsby schema
 * with proper node linking and type namespacing
 * also filters out unusable fields and types
 */


const transformFields = ({
  fields,
  fieldAliases,
  fieldBlacklist,
  parentType,
  parentInterfacesImplementingTypes
}) => {
  if (!fields || !fields.length) {
    return null;
  }

  const parentTypeSettings = (0, _helpers.getTypeSettingsByType)(parentType);
  const parentInterfacesImplementingTypeSettings = parentInterfacesImplementingTypes ? parentInterfacesImplementingTypes.map(type => (0, _helpers.getTypeSettingsByType)(type)) : null;
  const transformedFields = fields.reduce((fieldsObject, field) => {
    const thisTypeSettings = (0, _helpers.getTypeSettingsByType)(field.type);
    const fieldName = getAliasedFieldName({
      fieldAliases,
      field
    });

    if (excludeField({
      field,
      fieldName,
      thisTypeSettings,
      fieldBlacklist,
      parentTypeSettings,
      parentInterfacesImplementingTypeSettings
    })) {
      return fieldsObject;
    }

    field = handleCustomScalars(field);
    const {
      transform
    } = _fieldTransformers.fieldTransformers.find(({
      test
    }) => test(field)) || {};

    if (transform && typeof transform === `function`) {
      let transformedField = transform({
        field,
        fieldsObject,
        fieldName
      }); // add default resolver

      if (typeof transformedField === `string`) {
        // we need to add a custom resolver to override the default resolver
        // and check for aliased fields
        // fields are aliased automatically if they have conflicting types
        // with other fields of the same name when placed in side-by-side
        // inlineFragments on the same union or interface type.
        transformedField = {
          type: transformedField,
          resolve: source => {
            var _field, _field$type;

            const resolvedField = source[fieldName];

            if (typeof resolvedField !== `undefined`) {
              return resolvedField;
            }

            const autoAliasedFieldPropertyName = `${fieldName}__typename_${(_field = field) === null || _field === void 0 ? void 0 : (_field$type = _field.type) === null || _field$type === void 0 ? void 0 : _field$type.name}`;
            const aliasedField = source[autoAliasedFieldPropertyName];
            return aliasedField;
          }
        };
      }

      fieldsObject[fieldName] = transformedField;
    }

    return fieldsObject;
  }, {});
  return transformedFields;
};

exports.transformFields = transformFields;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGVwcy9jcmVhdGUtc2NoZW1hLWN1c3RvbWl6YXRpb24vdHJhbnNmb3JtLWZpZWxkcy9pbmRleC5qcyJdLCJuYW1lcyI6WyJoYW5kbGVDdXN0b21TY2FsYXJzIiwiZmllbGQiLCJmaWVsZFR5cGVJc0FDdXN0b21TY2FsYXIiLCJ0eXBlIiwia2luZCIsIm5hbWUiLCJmaWVsZFR5cGVPZlR5cGVJc0FDdXN0b21TY2FsYXIiLCJvZlR5cGUiLCJnZXRBbGlhc2VkRmllbGROYW1lIiwiZmllbGRBbGlhc2VzIiwicmV0dXJuQWxpYXNlZEZpZWxkTmFtZSIsImV4Y2x1ZGVGaWVsZCIsImZpZWxkTmFtZSIsInRoaXNUeXBlU2V0dGluZ3MiLCJmaWVsZEJsYWNrbGlzdCIsInBhcmVudFR5cGVTZXR0aW5ncyIsInBhcmVudEludGVyZmFjZXNJbXBsZW1lbnRpbmdUeXBlU2V0dGluZ3MiLCJleGNsdWRlRmllbGROYW1lcyIsImluY2x1ZGVzIiwiZmluZCIsInR5cGVTZXR0aW5nIiwiZXhjbHVkZWRGaWVsZE5hbWUiLCJleGNsdWRlIiwibm9kZUludGVyZmFjZSIsImFyZ3MiLCJhcmciLCJ0cmFuc2Zvcm1GaWVsZHMiLCJmaWVsZHMiLCJwYXJlbnRUeXBlIiwicGFyZW50SW50ZXJmYWNlc0ltcGxlbWVudGluZ1R5cGVzIiwibGVuZ3RoIiwibWFwIiwidHJhbnNmb3JtZWRGaWVsZHMiLCJyZWR1Y2UiLCJmaWVsZHNPYmplY3QiLCJ0cmFuc2Zvcm0iLCJmaWVsZFRyYW5zZm9ybWVycyIsInRlc3QiLCJ0cmFuc2Zvcm1lZEZpZWxkIiwicmVzb2x2ZSIsInNvdXJjZSIsInJlc29sdmVkRmllbGQiLCJhdXRvQWxpYXNlZEZpZWxkUHJvcGVydHlOYW1lIiwiYWxpYXNlZEZpZWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBT0EsTUFBTUEsbUJBQW1CLEdBQUlDLEtBQUQsSUFBVztBQUNyQyxRQUFNQyx3QkFBd0IsR0FDNUJELEtBQUss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S0FBRCxLQUFjQSxJQUFJLENBQUNwQyxLQUFELENBQXpDLEtBQXFELEVBRHZEOztBQUdBLFFBQUlrQyxTQUFTLElBQUksT0FBT0EsU0FBUCxLQUFzQixVQUF2QyxFQUFrRDtBQUNoRCxVQUFJRyxnQkFBZ0IsR0FBR0gsU0FBUyxDQUFDO0FBQy9CbEMsUUFBQUEsS0FEK0I7QUFFL0JpQyxRQUFBQSxZQUYrQjtBQUcvQnRCLFFBQUFBO0FBSCtCLE9BQUQsQ0FBaEMsQ0FEZ0QsQ0FPaEQ7O0FBQ0EsVUFBSSxPQUFPMEIsZ0JBQVAsS0FBNkIsUUFBakMsRUFBMEM7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBQSxRQUFBQSxnQkFBZ0IsR0FBRztBQUNqQm5DLFVBQUFBLElBQUksRUFBRW1DLGdCQURXO0FBRWpCQyxVQUFBQSxPQUFPLEVBQUdDLE1BQUQsSUFBWTtBQUFBOztBQUNuQixrQkFBTUMsYUFBYSxHQUFHRCxNQUFNLENBQUM1QixTQUFELENBQTVCOztBQUVBLGdCQUFJLE9BQU82QixhQUFQLEtBQTBCLFdBQTlCLEVBQTBDO0FBQ3hDLHFCQUFPQSxhQUFQO0FBQ0Q7O0FBRUQsa0JBQU1DLDRCQUE0QixHQUFJLEdBQUU5QixTQUFVLGNBQWIsVUFBMEJYLEtBQTFCLDBEQUEwQixPQUFPRSxJQUFqQyxnREFBMEIsWUFBYUUsSUFBSyxFQUFqRjtBQUVBLGtCQUFNc0MsWUFBWSxHQUFHSCxNQUFNLENBQUNFLDRCQUFELENBQTNCO0FBRUEsbUJBQU9DLFlBQVA7QUFDRDtBQWRnQixTQUFuQjtBQWdCRDs7QUFFRFQsTUFBQUEsWUFBWSxDQUFDdEIsU0FBRCxDQUFaLEdBQTBCMEIsZ0JBQTFCO0FBQ0Q7O0FBRUQsV0FBT0osWUFBUDtBQUNELEdBM0R5QixFQTJEdkIsRUEzRHVCLENBQTFCO0FBNkRBLFNBQU9GLGlCQUFQO0FBQ0QsQ0FqRk0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmaWVsZFRyYW5zZm9ybWVycyB9IGZyb20gXCIuL2ZpZWxkLXRyYW5zZm9ybWVyc1wiXG5pbXBvcnQge1xuICBmaWVsZE9mVHlwZVdhc0ZldGNoZWQsXG4gIHR5cGVJc0FTdXBwb3J0ZWRTY2FsYXIsXG4gIGdldFR5cGVTZXR0aW5nc0J5VHlwZSxcbiAgZmluZFR5cGVOYW1lLFxufSBmcm9tIFwiLi4vaGVscGVyc1wiXG5cbmNvbnN0IGhhbmRsZUN1c3RvbVNjYWxhcnMgPSAoZmllbGQpID0+IHtcbiAgY29uc3QgZmllbGRUeXBlSXNBQ3VzdG9tU2NhbGFyID1cbiAgICBmaWVsZC50eXBlLmtpbmQgPT09IGBTQ0FMQVJgICYmICF0eXBlSXNBU3VwcG9ydGVkU2NhbGFyKGZpZWxkLnR5cGUpXG5cbiAgaWYgKGZpZWxkVHlwZUlzQUN1c3RvbVNjYWxhcikge1xuICAgIC8vIGlmIHRoaXMgZmllbGQgaXMgYW4gdW5zdXBwb3J0ZWQgY3VzdG9tIHNjYWxhcixcbiAgICAvLyB0eXBlIGl0IGFzIEpTT05cbiAgICBmaWVsZC50eXBlLm5hbWUgPSBgSlNPTmBcbiAgfVxuXG4gIGNvbnN0IGZpZWxkVHlwZU9mVHlwZUlzQUN1c3RvbVNjYWxhciA9XG4gICAgZmllbGQudHlwZS5vZlR5cGUgJiZcbiAgICBmaWVsZC50eXBlLm9mVHlwZS5raW5kID09PSBgU0NBTEFSYCAmJlxuICAgICF0eXBlSXNBU3VwcG9ydGVkU2NhbGFyKGZpZWxkLnR5cGUpXG5cbiAgaWYgKGZpZWxkVHlwZU9mVHlwZUlzQUN1c3RvbVNjYWxhcikge1xuICAgIC8vIGlmIHRoaXMgZmllbGQgaXMgYW4gdW5zdXBwb3J0ZWQgY3VzdG9tIHNjYWxhcixcbiAgICAvLyB0eXBlIGl0IGFzIEpTT05cbiAgICBmaWVsZC50eXBlLm9mVHlwZS5uYW1lID0gYEpTT05gXG4gIH1cblxuICByZXR1cm4gZmllbGRcbn1cblxuLy8gdGhpcyBpcyB1c2VkIHRvIGFsaWFzIGZpZWxkcyB0aGF0IGNvbmZsaWN0IHdpdGggR2F0c2J5IG5vZGUgZmllbGRzXG4vLyBmb3IgZXggR2F0c2J5IGFuZCBXUEdRTCBib3RoIGhhdmUgYSBgcGFyZW50YCBmaWVsZFxuZXhwb3J0IGNvbnN0IGdldEFsaWFzZWRGaWVsZE5hbWUgPSAoeyBmaWVsZEFsaWFzZXMsIGZpZWxkIH0pID0+XG4gIGZpZWxkQWxpYXNlcyAmJiBmaWVsZEFsaWFzZXNbZmllbGQubmFtZV1cbiAgICA/IGZpZWxkQWxpYXNlc1tmaWVsZC5uYW1lXVxuICAgIDogZmllbGQubmFtZVxuXG5leHBvcnQgY29uc3QgcmV0dXJuQWxpYXNlZEZpZWxkTmFtZSA9ICh7IGZpZWxkQWxpYXNlcywgZmllbGQgfSkgPT5cbiAgZmllbGRBbGlhc2VzICYmIGZpZWxkQWxpYXNlc1tmaWVsZC5uYW1lXVxuICAgID8gYCR7ZmllbGRBbGlhc2VzW2ZpZWxkLm5hbWVdfTogJHtmaWVsZC5uYW1lfWBcbiAgICA6IGZpZWxkLm5hbWVcblxuY29uc3QgZXhjbHVkZUZpZWxkID0gKHtcbiAgZmllbGQsXG4gIGZpZWxkTmFtZSxcbiAgdGhpc1R5cGVTZXR0aW5ncyxcbiAgZmllbGRCbGFja2xpc3QsXG4gIHBhcmVudFR5cGVTZXR0aW5ncyxcbiAgcGFyZW50SW50ZXJmYWNlc0ltcGxlbWVudGluZ1R5cGVTZXR0aW5ncyxcbn0pID0+XG4gIC8vIHRoaXMgZmllbGQgd2Fzbid0IHByZXZpb3VzbHkgZmV0Y2hlZCwgc28gd2Ugc2hvdWxkbid0XG4gIC8vIGFkZCBpdCB0byBvdXIgc2NoZW1hXG4gICFmaWVsZE9mVHlwZVdhc0ZldGNoZWQoZmllbGQudHlwZSkgfHxcbiAgLy8gdGhpcyBmaWVsZCB3YXMgZXhjbHVkZWQgb24gaXQncyBwYXJlbnQgZmllbGRzIFR5cGVcbiAgKHBhcmVudFR5cGVTZXR0aW5ncy5leGNsdWRlRmllbGROYW1lcyAmJlxuICAgIHBhcmVudFR5cGVTZXR0aW5ncy5leGNsdWRlRmllbGROYW1lcy5pbmNsdWRlcyhmaWVsZE5hbWUpKSB8fFxuICAvLyB0aGlzIGZpZWxkIGlzIG9uIGFuIGludGVyZmFjZSB0eXBlIGFuZCBvbmUgb2YgdGhlIGltcGxlbWVudGluZyB0eXBlcyBoYXMgdGhpcyBmaWVsZCBleGNsdWRlZCBvbiBpdC5cbiAgKHBhcmVudEludGVyZmFjZXNJbXBsZW1lbnRpbmdUeXBlU2V0dGluZ3MgJiZcbiAgICBwYXJlbnRJbnRlcmZhY2VzSW1wbGVtZW50aW5nVHlwZVNldHRpbmdzLmZpbmQoXG4gICAgICAodHlwZVNldHRpbmcpID0+XG4gICAgICAgIHR5cGVTZXR0aW5nLmV4Y2x1ZGVGaWVsZE5hbWVzICYmXG4gICAgICAgIHR5cGVTZXR0aW5nLmV4Y2x1ZGVGaWVsZE5hbWVzLmZpbmQoXG4gICAgICAgICAgKGV4Y2x1ZGVkRmllbGROYW1lKSA9PiBmaWVsZE5hbWUgPT09IGV4Y2x1ZGVkRmllbGROYW1lXG4gICAgICAgIClcbiAgICApKSB8fFxuICAvLyB0aGUgdHlwZSBvZiB0aGlzIGZpZWxkIHdhcyBleGNsdWRlZCB2aWEgcGx1Z2luIG9wdGlvbnNcbiAgdGhpc1R5cGVTZXR0aW5ncy5leGNsdWRlIHx8XG4gIC8vIG5vZGUgaW50ZXJmYWNlIHR5cGVzIGFyZSBjcmVhdGVkIGVsc2V3aGVyZVxuICB0aGlzVHlwZVNldHRpbmdzLm5vZGVJbnRlcmZhY2UgfHxcbiAgLy8gZmllbGQgaXMgYmxhY2tsaXN0ZWRcbiAgZmllbGRCbGFja2xpc3QuaW5jbHVkZXMoZmllbGROYW1lKSB8fFxuICAvLyB0aGlzIGZpZWxkIGhhcyByZXF1aXJlZCBpbnB1dCBhcmdzXG4gIChmaWVsZC5hcmdzICYmIGZpZWxkLmFyZ3MuZmluZCgoYXJnKSA9PiBhcmcudHlwZS5raW5kID09PSBgTk9OX05VTExgKSkgfHxcbiAgLy8gdGhpcyBmaWVsZCBoYXMgbm8gdHlwZU5hbWVcbiAgIWZpbmRUeXBlTmFtZShmaWVsZC50eXBlKSB8fFxuICAvLyBmaWVsZCBpcyBhIG5vbiBudWxsIG9iamVjdFxuICAvLyBAdG9kbyB0aGlzIGxvb2tzIHVubmVjZXNzYXJ5LiBOZWVkIHRvIGxvb2sgaW50byB3aHkgbm9uIG51bGwgb2JqZWN0IHR5cGVzIGFyZSBleGNsdWRlZFxuICAoZmllbGQudHlwZS5raW5kID09PSBgTk9OX05VTExgICYmIGZpZWxkLnR5cGUub2ZUeXBlLmtpbmQgPT09IGBPQkpFQ1RgKSB8fFxuICAvLyBmaWVsZCBpcyBhIG5vbiBudWxsIGVudW1cbiAgKGZpZWxkLnR5cGUua2luZCA9PT0gYE5PTl9OVUxMYCAmJiBmaWVsZC50eXBlLm9mVHlwZS5raW5kID09PSBgRU5VTWApXG5cbi8qKlxuICogVHJhbnNmb3JtcyBmaWVsZHMgZnJvbSB0aGUgV1BHUUwgc2NoZW1hIHRvIHdvcmsgaW4gdGhlIEdhdHNieSBzY2hlbWFcbiAqIHdpdGggcHJvcGVyIG5vZGUgbGlua2luZyBhbmQgdHlwZSBuYW1lc3BhY2luZ1xuICogYWxzbyBmaWx0ZXJzIG91dCB1bnVzYWJsZSBmaWVsZHMgYW5kIHR5cGVzXG4gKi9cblxuZXhwb3J0IGNvbnN0IHRyYW5zZm9ybUZpZWxkcyA9ICh7XG4gIGZpZWxkcyxcbiAgZmllbGRBbGlhc2VzLFxuICBmaWVsZEJsYWNrbGlzdCxcbiAgcGFyZW50VHlwZSxcbiAgcGFyZW50SW50ZXJmYWNlc0ltcGxlbWVudGluZ1R5cGVzLFxufSkgPT4ge1xuICBpZiAoIWZpZWxkcyB8fCAhZmllbGRzLmxlbmd0aCkge1xuICAgIHJldHVybiBudWxsXG4gIH1cblxuICBjb25zdCBwYXJlbnRUeXBlU2V0dGluZ3MgPSBnZXRUeXBlU2V0dGluZ3NCeVR5cGUocGFyZW50VHlwZSlcblxuICBjb25zdCBwYXJlbnRJbnRlcmZhY2VzSW1wbGVtZW50aW5nVHlwZVNldHRpbmdzID0gcGFyZW50SW50ZXJmYWNlc0ltcGxlbWVudGluZ1R5cGVzXG4gICAgPyBwYXJlbnRJbnRlcmZhY2VzSW1wbGVtZW50aW5nVHlwZXMubWFwKCh0eXBlKSA9PlxuICAgICAgICBnZXRUeXBlU2V0dGluZ3NCeVR5cGUodHlwZSlcbiAgICAgIClcbiAgICA6IG51bGxcblxuICBjb25zdCB0cmFuc2Zvcm1lZEZpZWxkcyA9IGZpZWxkcy5yZWR1Y2UoKGZpZWxkc09iamVjdCwgZmllbGQpID0+IHtcbiAgICBjb25zdCB0aGlzVHlwZVNldHRpbmdzID0gZ2V0VHlwZVNldHRpbmdzQnlUeXBlKGZpZWxkLnR5cGUpXG5cbiAgICBjb25zdCBmaWVsZE5hbWUgPSBnZXRBbGlhc2VkRmllbGROYW1lKHsgZmllbGRBbGlhc2VzLCBmaWVsZCB9KVxuXG4gICAgaWYgKFxuICAgICAgZXhjbHVkZUZpZWxkKHtcbiAgICAgICAgZmllbGQsXG4gICAgICAgIGZpZWxkTmFtZSxcbiAgICAgICAgdGhpc1R5cGVTZXR0aW5ncyxcbiAgICAgICAgZmllbGRCbGFja2xpc3QsXG4gICAgICAgIHBhcmVudFR5cGVTZXR0aW5ncyxcbiAgICAgICAgcGFyZW50SW50ZXJmYWNlc0ltcGxlbWVudGluZ1R5cGVTZXR0aW5ncyxcbiAgICAgIH0pXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmllbGRzT2JqZWN0XG4gICAgfVxuXG4gICAgZmllbGQgPSBoYW5kbGVDdXN0b21TY2FsYXJzKGZpZWxkKVxuXG4gICAgY29uc3QgeyB0cmFuc2Zvcm0gfSA9XG4gICAgICBmaWVsZFRyYW5zZm9ybWVycy5maW5kKCh7IHRlc3QgfSkgPT4gdGVzdChmaWVsZCkpIHx8IHt9XG5cbiAgICBpZiAodHJhbnNmb3JtICYmIHR5cGVvZiB0cmFuc2Zvcm0gPT09IGBmdW5jdGlvbmApIHtcbiAgICAgIGxldCB0cmFuc2Zvcm1lZEZpZWxkID0gdHJhbnNmb3JtKHtcbiAgICAgICAgZmllbGQsXG4gICAgICAgIGZpZWxkc09iamVjdCxcbiAgICAgICAgZmllbGROYW1lLFxuICAgICAgfSlcblxuICAgICAgLy8gYWRkIGRlZmF1bHQgcmVzb2x2ZXJcbiAgICAgIGlmICh0eXBlb2YgdHJhbnNmb3JtZWRGaWVsZCA9PT0gYHN0cmluZ2ApIHtcbiAgICAgICAgLy8gd2UgbmVlZCB0byBhZGQgYSBjdXN0b20gcmVzb2x2ZXIgdG8gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgcmVzb2x2ZXJcbiAgICAgICAgLy8gYW5kIGNoZWNrIGZvciBhbGlhc2VkIGZpZWxkc1xuICAgICAgICAvLyBmaWVsZHMgYXJlIGFsaWFzZWQgYXV0b21hdGljYWxseSBpZiB0aGV5IGhhdmUgY29uZmxpY3RpbmcgdHlwZXNcbiAgICAgICAgLy8gd2l0aCBvdGhlciBmaWVsZHMgb2YgdGhlIHNhbWUgbmFtZSB3aGVuIHBsYWNlZCBpbiBzaWRlLWJ5LXNpZGVcbiAgICAgICAgLy8gaW5saW5lRnJhZ21lbnRzIG9uIHRoZSBzYW1lIHVuaW9uIG9yIGludGVyZmFjZSB0eXBlLlxuICAgICAgICB0cmFuc2Zvcm1lZEZpZWxkID0ge1xuICAgICAgICAgIHR5cGU6IHRyYW5zZm9ybWVkRmllbGQsXG4gICAgICAgICAgcmVzb2x2ZTogKHNvdXJjZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWRGaWVsZCA9IHNvdXJjZVtmaWVsZE5hbWVdXG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzb2x2ZWRGaWVsZCAhPT0gYHVuZGVmaW5lZGApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkRmllbGRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYXV0b0FsaWFzZWRGaWVsZFByb3BlcnR5TmFtZSA9IGAke2ZpZWxkTmFtZX1fX3R5cGVuYW1lXyR7ZmllbGQ/LnR5cGU/Lm5hbWV9YFxuXG4gICAgICAgICAgICBjb25zdCBhbGlhc2VkRmllbGQgPSBzb3VyY2VbYXV0b0FsaWFzZWRGaWVsZFByb3BlcnR5TmFtZV1cblxuICAgICAgICAgICAgcmV0dXJuIGFsaWFzZWRGaWVsZFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZmllbGRzT2JqZWN0W2ZpZWxkTmFtZV0gPSB0cmFuc2Zvcm1lZEZpZWxkXG4gICAgfVxuXG4gICAgcmV0dXJuIGZpZWxkc09iamVjdFxuICB9LCB7fSlcblxuICByZXR1cm4gdHJhbnNmb3JtZWRGaWVsZHNcbn1cbiJdfQ==